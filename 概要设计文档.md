# 概要设计文档

## 1. 总体架构
- **表示层**：`Maingame` 主窗口负责游戏界面、动画与音效；`Loadprocess` 启动画面；`EndPanel` 结算窗口；`CardPanel`、`MyButtonGroup`、`Timecount` 等 UI 控件。
- **业务控制层**：`gamecontrol` 维护牌堆、状态机（发牌/抢地主/出牌）、分数与信号槽，与 UI 协同调度流程。
- **领域层**：玩家基类 `player` 及子类 `user`、`robot`；`Card`/`Cards` 表示牌与集合；`PlayHand` 判型；`Strategy`、`robotgetloard`、`robotplayhand` 实现 AI 决策。
- **资源层**：`Bgmcontrol` 播放背景音乐和音效，`res.qrc` 管理图片、音频与 JSON 配置。

## 2. 模块划分与关系
- `Maingame` 创建并持有 `gamecontrol`，订阅游戏状态、抢地主、出牌、倒计时与结算信号，负责界面更新与玩家操作响应。`【F:maingame.cpp†L57-L138】【F:maingame.cpp†L470-L529】`
- `gamecontrol` 管理三名 `player` 对象，负责初始化玩家链表、洗牌发牌、抢地主轮询、出牌验证、倍数与分数计算，并通过信号通知 UI。`【F:gamecontrol.cpp†L8-L138】【F:gamecontrol.cpp†L176-L287】`
- `player` 负责手牌集合、前后家关系、角色/性别/位置、出牌与叫分信号；`user` 由 UI 驱动，`robot` 在后台线程内使用 `Strategy` 完成叫分与出牌。`【F:player.h†L13-L105】【F:robot.cpp†L3-L73】`
- 资源与控件：`CardPanel` 负责单牌显示与选中状态；`MyButtonGroup` 控制抢地主/出牌按钮；`Timecount` 倒计时与提醒；`Bgmcontrol` 根据事件播放音效；动画由 `AnmationPixmap` 展示。

## 3. 主要流程
- **启动与加载**：`main.cpp` 创建 `QApplication`，先显示 `Loadprocess` 过场，再进入 `Maingame` 初始化资源与控制器。
- **发牌**：`gamecontrol::SetAllCards` 生成 54 张牌；`Maingame::SatrtPend` 启动定时器分发牌面与动画。`【F:gamecontrol.cpp†L71-L102】【F:maingame.cpp†L309-L377】`
- **抢地主**：`gamecontrol::StartPrepareLord` 触发当前玩家叫分；`Onbet` 统计轮次与最高叫分，三轮无人叫则重新洗牌，确定地主后发底牌并切换到出牌状态。`【F:gamecontrol.cpp†L145-L175】【F:gamecontrol.cpp†L307-L350】`
- **出牌**：`GamePlayhand` 校验要不起与有效出牌，更新出牌记录、倍数、结算与下一轮；`Maingame::OndisPosePlayhand` 渲染出牌/要不起标签与音效。`【F:gamecontrol.cpp†L176-L287】【F:maingame.cpp†L638-L689】`
- **结算与重开**：当某玩家手牌为空，计算分数、胜负并弹出 `EndPanel`；`RePlayGame` 或结算按钮调用 `RetCardDate` 重置牌堆与 UI 状态。`【F:gamecontrol.cpp†L240-L287】【F:maingame.cpp†L875-L932】`

## 4. 界面结构
- 主窗口 1000×650：背景图、三方手牌区与出牌区、头像/身份标签、“不要”提示、按钮组（抢地主/出牌/不要/开始）、倒计时与动画、分数面板。`【F:maingame.cpp†L11-L55】【F:maingame.cpp†L221-L309】`
- 启动画面：`Loadprocess` 采用计时器绘制进度条与背景图（详见 `loadprocess.*`）。
- 结算面板：`EndPanel` 通过动画显示胜负信息和继续按钮。`【F:maingame.cpp†L875-L936】`

## 5. 关键数据结构
- `Card`：包含点数 `cardpoint`、花色 `cardsuit`，支持比较与哈希，用于 `QSet` 存储。
- `Cards`：`QSet<Card*>` 封装手牌集合，提供增删、随机抽牌、排序（升序）与统计。
- `PlayHand`：根据 `Cards` 分类识别牌型，提供能否压制的判定接口。
- `_Playercontext`（`Maingame` 内部）：记录玩家手牌区、出牌区、头像位置、提示标签及上一手牌缓存，支撑界面布局。`【F:maingame.cpp†L223-L309】【F:maingame.cpp†L603-L636】`

## 6. 技术选型
- Qt Widgets 搭建界面与事件响应；`QTimer` 驱动发牌与倒计时；信号槽连接游戏控制与 UI。
- Qt Multimedia 播放背景音乐与操作音效；Qt 资源系统通过 `res.qrc` 打包图片、音效和配置。
- 无外部数据库或网络依赖，AI 策略完全本地实现于 `Strategy` 与机器人线程。
