## 三、详细设计文档
### 1. 主要类与成员
- **Loadprocess**：持有主背景与进度图，`paintEvent` 绘制加载动画，`QTimer` 驱动进度。
- **Maingame**：
  - 成员：图像资源 `_IMage_Map/_IMage_Cards/_Card_back`，`gamecontrol* _Gamecontrol`，玩家上下文映射 `_Playercontexts`，发牌/移动卡片 `CardPanel` 指针，计时器 `_Timer_PlayHand`，音效控制 `_Bgmcontrol`，动画 `_MyAnmation`，倒计时 `_Timecount` 等。
  - 核心方法：
    - `InitGamecontrol` 连接信号、初始化玩家与牌堆。【F:maingame.cpp†L57-L86】
    - `InitCardpanelMap` 裁剪卡面图片并生成 `CardPanel` 映射。【F:maingame.cpp†L177-L200】
    - `InitGameScene`/`InitGroupbtn` 设置 UI 区域与按钮。
    - `SatrtPend`、`PendCardplayer`、`PendCardpos` 负责发牌动画与落位。
    - `PlayerStateChange` 响应状态：抢地主按钮显示、出牌按钮状态、倒计时启动等。
    - `OndisPosePlayhand` 根据 `Cards*` 渲染出牌；空牌表示“要不起”并显示标签/音效。【F:maingame.cpp†L481-L518】
    - `UserPlayHand` / `UserNoPlayer` 触发用户出牌或不出牌信号。
    - `RePlayGame` 清理状态、重新开始；注意 `_Playercontexts` 中 `_Last_Cards` 需判空。【F:maingame.cpp†L703-L733】
- **gamecontrol**：
  - 状态枚举 `GameState`（发牌/抢地主/出牌）与 `USERSTATE`（抢地主/出牌/胜利）。
  - 流程方法：`InitPlayer` 构建三名玩家并连接信号；`SetAllCards` 初始化牌堆；`StartPrepareLord` 开启叫分；`Onbet` 统计最高分并决定重新发牌或 `BecomeLord`；`GamePlayhand` 处理出牌/要不起、倍数、胜负判定；`RetCardDate` 重新开局清理状态。【F:gamecontrol.cpp†L8-L347】
- **player**：
  - 管理手牌集合 `Cards _Cards`，记录前后家链表，角色/性别/位置等元信息；
  - 提供 `PrepareGetLord`、`PreparePlayCard` 作为用户/机器人行为入口；信号 `notifygrablordbet`、`notifyplayhand` 反馈操作。
- **user**：
  - 继承 `player`，重写 `PrepareGetLord`、`PreparePlayCard`，由 UI 按钮驱动信号发送。【F:user.h†L1-L13】
- **robot**：
  - 继承 `player`，在 `RobotGetLard`、`RobotThinkPlayhand` 中使用 `Strategy` 计算叫分/出牌，触发相应信号。【F:robot.h†L1-L20】
- **Strategy**：
  - 根据当前手牌与对手牌型评估（`EvaluateHandStrength`、`ShouldPressCard`），生成可行牌组（`GetrootPlayhand`、`FirstPlayhand`、`Getbigplayhand` 等），支撑机器人决策。【F:strategy.h†L1-L49】
- **PlayHand**：
  - 将 `Cards` 分类并识别牌型；提供 `CanBeat` 判定能否压制上一手；暴露牌型、关键点数、张数等信息。【F:playhand.h†L1-L57】
- **UI 及辅助类**：
  - `CardPanel` 表示单张卡牌的图元与选中状态；`MyButton`/`MyButtonGroup` 管理交互按钮；`Timecount` 显示倒计时；`Bgmcontrol` 控制背景音乐与音效；`AnmationPixmap` 用于连胜/出牌动画；`EndPanel` 展示胜负信息。

### 2. 关键流程与状态
- **出牌状态流转**（`gamecontrol::GamePlayhand`）：
  1. 接收玩家与牌组；若为空则视为“要不起”，不更新出牌记录，仅切换到下家并通知 UI。【F:gamecontrol.cpp†L176-L205】
  2. 正常出牌：更新 `_PlayHandplayer/_PlayHandCards/_CurrentPlayer`，移除玩家手牌，广播信号。【F:gamecontrol.cpp†L209-L223】
  3. 若出炸弹翻倍；若手牌清空则计算分数与胜负，发射结果信号。【F:gamecontrol.cpp†L233-L275】
  4. 否则切换下家并调用其 `PreparePlayCard`。【F:gamecontrol.cpp†L277-L287】
- **叫分/抢地主**（`Onbet`）：统计最高叫分与首叫标记，三轮后若无人叫分则重新发牌，否则调用 `BecomeLord` 发底牌并进入出牌阶段。【F:gamecontrol.cpp†L307-L347】
- **重新开局**：`RetCardDate` 重置牌堆、玩家手牌、出牌记录、倍数与倒计时，防止状态泄漏。【F:gamecontrol.cpp†L110-L138】

### 3. 接口说明
- `gamecontrol::S_gamePlayHand(player*, Cards*)`：通知界面刷新出牌或“要不起”。
- `gamecontrol::S_PlayerStateChange(player*, USERSTATE)`：驱动 UI 更新按钮与提示。
- `player::notifygrablordbet(player*, int)`：玩家叫分信号。
- `player::notifyplayhand(player*, Cards*)`：玩家出牌信号。
- `Maingame` 槽函数 `gamenotifyGetLoard`、`OndisPosePlayhand`、`PlayerStateChange` 等接收上述信号。

### 4. 关键算法
- **牌型识别**：`PlayHand::classify/judeHandType` 将手牌按数量分组，判断顺子、连对、飞机、炸弹、王炸等牌型。
- **AI 出牌策略**：`Strategy::EvaluateHandStrength` 等评分函数评估手牌强度，`ShouldPressCard` 判断是否压制上一手，`FindHand_*` 系列搜索满足条件的牌组（如三带、飞机、顺子）。
