# 详细设计文档

## 1. Loadprocess
- 职责：显示加载动画并在资源准备完成后创建主界面。
- 关键逻辑：
  - 组件：`QTimer` 控制进度增长；`QPainter` 绘制背景与进度条。
  - 界面：无边框、透明背景，固定大小与加载图片匹配。
  - 触发：进度到达图片宽度即停止计时器，创建 `Maingame`，关闭自身。

## 2. Maingame
- 主要成员
  - 资源：背景图 `_IMage_Map`、牌面雪碧图 `_IMage_Cards`、牌背 `_Card_back`。
  - 控件：牌面控件 `_CardPenelMap`、发牌/移动牌 `_PendCards`/`_MoveCards`、地主牌 `_LordCards[3]`。
  - 上下文：`_Playercontexts`（位置、翻面、标签、最后出牌）、选中集合 `_SelcetPanel`、倒计时 `_Timecount`、音效 `_Bgmcontrol`、动画 `_MyAnmation`。
- 状态与流程
  - 状态机：`SetCurrentGameStatue`（发牌 PENDCARD / 抢地主 GETLORD / 出牌 GIVECARD），控制按钮组、音效、底牌展示、清理标签。
  - 发牌：`PlayHandtimer` 按座位循环发牌；当牌池剩 3 张时生成地主牌面板、停发牌音效并进入抢地主。
  - 抢地主：`gamenotifyGetLoard` 展示叫分/抢分贴图与音效；叫分完成后 `OnLordDetermined` 设置头像与首出标记。
  - 出牌：`UserPlayHand` 校验牌型和压制合法性，合法后触发 `PlayHand`；`UserNoPlayer` 生成空牌表示要不起；`AutoPlayFirstCard` 在自由出牌超时时自动打出首张。
  - 轮转与显示：`OndisPosePlayhand` 处理出牌/要不起展示与音效，`HidePlayhand` 清理上一轮牌面，`PendCardpos` 重新布局手牌与出牌。
  - 结算：`PlayerStateChange` 进入 USERWIN 分支时亮出机器人手牌、保存分数，`InitEndPanel` 播放结算面板动画与按钮，继续后调用 `_Gamecontrol->RetCardDate` 重置一局。
- 交互与容错
  - 选牌：点击/拖拽命中 `_PanelPositon`，允许轻微越界（容差 -10~+10）；右键快捷出牌。
  - 选牌反馈：点击选牌播放选牌音效；`ClearSelectedPanels` 每次出牌后重置选择。
  - 倒计时：仅在当前轮到用户且处于出牌阶段时启动；5 秒时播放提醒音；超时自动出牌或“不出”。
- 标签与动画
  - 要不起/叫分/角色标签位置通过 `CalculateLabelPosAbovePlayArea` 与 `CalculateRoleLabelPos` 基于玩家区域自适应居中。
  - 动画：顺子/连对/飞机/炸弹调用 `Showanimation` 播放对应动画与特效音。

## 3. gamecontrol
- 核心成员：当前玩家 `_CurrentPlayer`、当前出牌 `_CurrentCards`、上一出牌玩家 `_PlayHandplayer`、叫分状态 `_Betrect`、牌堆 `_AllCards`、倍数 `_Bet`。
- 初始化：`InitPlayer` 创建三名玩家并构建前后指针，随机性别，连接叫分与出牌信号。
- 牌堆管理：`SetAllCards` 重置牌堆并填充 54 张牌；`TakeOneCard` 随机取牌并减少计数。
- 流程控制：
  - `Onbet` 记录最高分与首家标记；三轮后无人叫分则重发牌，有人叫分则成为地主并进入出牌。
  - `BecomeLord` 设置角色、分发底牌、发射地主确定信号，延迟切换到出牌阶段。
  - `GamePlayhand`：要不起不更新出牌记录，仅轮转下家；正常出牌时更新当前出牌、移除手牌、倍数翻倍（炸弹）、判断是否结束，胜负后发射播放结果与状态变更信号。
  - 重置：`RetCardDate` 清空牌堆、玩家手牌与状态、叫分与倍数，发射停止倒计时信号。

## 4. player / robot / user
- `player`
  - 数据：手牌 `Cards _Cards`、前后指针、角色/性别/位置、胜负标记、最近出牌者与出牌记录。
  - 行为：`StoreGetCard(s)` 加牌并通知 UI；`PlayHand` 发射出牌信号；`ResetForNewGame` 清空状态；`GetPlayerRolePixmap` 按角色/性别加载头像并根据位置镜像。
- `robot`
  - 线程入口：`PrepareGetLord`→`Robotgetloard` 延时调用 `RobotGetLard`；`PreparePlayCard`→`RobotPlayhand` 延时调用 `RobotThinkPlayhand`。
  - 叫分策略：统计大小王、顺子/炸弹、2、对子、三张权重决定叫分档位。
  - 出牌策略：`RobotThinkPlayhand` 直接调用 `Strategy::GetrootPlayhand`，结果交由 `PlayHand` 判型与 `gamecontrol` 处理。
- `user`
  - 仅在轮到用户准备叫分/出牌时发射倒计时通知，具体操作由 UI 交互完成。

## 5. Strategy / PlayHand
- `PlayHand`
  - 分类：统计不同点数的数量，识别单、对、三带一/对、连对、顺子、飞机（带单/带对）、炸弹、王炸。
  - 压制：`CanBeat` 支持同类型比较、炸弹压制非炸弹、王炸最大；校验张数一致性。
- `Strategy`
  - 首出策略：优先长连（顺子/连对）、飞机带牌，其次三带、对子、单牌，最后才用炸弹，目标是快速减少手牌并保持结构。
  - 压制策略：考虑队友身份、上家/下家剩余牌数、是否需要保留炸弹或双王；若对手将走牌，优先可直接压制的组合。
  - 工具：`Getsamecount`、`FindHand_parisim`、`FindHand_Plane12` 等组合搜索函数；`EvaluateCardValue` 评估出牌后剩余手牌的整齐度与炸弹拆分惩罚。

## 6. 视听与动画
- `Bgmcontrol`
  - 播放器：男女语音各一、背景音乐、辅助音效、结算音效共 5 路播放器，背景音量较低、特效音量较高。
  - 播放列表：`InitMusicPlayer` 从 `conf/playList.json` 读取男女出牌音效、BGM、结果音效与其他特效音。
  - 出牌音效：根据性别、牌型、是否首出/压牌决定音轨；要不起固定播放“不要”；炸弹/飞机/顺子等触发特效或“打你”追加语音。
  - 叫分音效：区分首家叫分和后手抢分，未叫分播放“不叫/不抢”。
  - 其他：发牌循环音、选牌提示音、倒计时提醒音。
- `AnmationPixmap`
  - 牌型动画：顺子/连对静态贴图，炸弹/王炸序列帧轮播，飞机动画按位置移动并切换帧。
  - 叫分动画：显示 1/2/3 分或“不抢”贴图，配合叫分阶段展示。

## 7. UI 控件与辅助模块
- `CardPanel`：封装单张牌的正/背面、所属玩家、点击信号；支持翻面与选中状态。
- `MybuttonGroup`：stackedWidget 切换“开始”“首出”“出牌/要不起”“叫分”界面，统一初始化按钮皮肤与大小。
- `Timecount`：倒计时控件，绘制背景与数字贴图，5 秒触发提醒，0 秒发射超时信号并重置。
- `ShowScore`：显示三名玩家分数，支持多局累加；字体与颜色透明背景样式。
- `EndPanel`：根据角色与胜负展示结果图，包含继续按钮与当局分数显示，支持弹跳动画入场。
