# 详细设计文档

## 1. 类与组件设计
### 1.1 游戏控制与状态
- **gamecontrol**：
  - 负责玩家链表初始化、洗牌发牌、当前出牌者记录、倍数与分数计算。
  - 核心状态字段：`_CurrentPlayer`、`_CurrentCards`、`_PlayHandplayer`、`_PlayHandCards`、`_Bet`、`_Betrect`。
  - 关键方法：
    - `InitPlayer()` 创建左右机器人和用户，建立前后家指针，并连接叫分/出牌信号。`【F:gamecontrol.cpp†L8-L49】`
    - `SetAllCards()` 重置 54 张牌堆与计数；`TakeOneCard()` 随机取牌。`【F:gamecontrol.cpp†L71-L102】`
    - `StartPrepareLord()` 触发当前玩家叫分，发送状态信号；`Onbet()` 统计三轮叫分并决定重发或确定地主。`【F:gamecontrol.cpp†L145-L175】【F:gamecontrol.cpp†L307-L350】`
    - `BecomeLord()` 设置角色、发底牌、发射地主确定信号并切换到出牌状态。`【F:gamecontrol.cpp†L153-L175】`
    - `GamePlayhand()` 处理要不起、正常出牌、倍数翻倍、胜负结算，并轮转到下家。`【F:gamecontrol.cpp†L176-L287】`
    - `RetCardDate()` 重置牌堆、玩家状态、记录与倍数，清理上一局数据。`【F:gamecontrol.cpp†L110-L138】`

### 1.2 界面层
- **Maingame**：主窗口，负责资源裁剪、布局、发牌动画、按钮状态、出牌渲染、倒计时与音效控制。
  - 初始化：构造函数设置窗口/背景、创建动画与音乐、初始化控制器、分数、卡牌贴图、场景和按钮。`【F:maingame.cpp†L11-L55】`
  - 资源：`InitCardpanelMap()` 裁剪卡面，创建 `CardPanel` 映射；`InitGameScene()` 初始化发牌控件；`InitMovepoint()` 记录发牌坐标。`【F:maingame.cpp†L177-L220】【F:maingame.cpp†L1323-L1342】【F:maingame.cpp†L460-L469】`
  - 布局：`InitGroupbtn()` 定义三方手牌区、出牌区、头像与提示标签位置，并连接按钮信号。`【F:maingame.cpp†L221-L309】`
  - 流程：
    - 发牌：`SatrtPend()` 重置状态、显示发牌音效和定时器；`PlayHandtimer()` 按顺序发牌并在剩 3 张时展示底牌。`【F:maingame.cpp†L309-L377】【F:maingame.cpp†L377-L459】`
    - 状态切换：`SetCurrentGameStatue()` 根据状态控制按钮、动画与发牌/出牌阶段。`【F:maingame.cpp†L470-L529】`
    - 出牌展示：`PendCardpos()` 按阵营布局手牌与出牌；`OndisPosePlayhand()` 处理“要不起”提示、音效与动画；`HidePlayhand()` 清理上一手。`【F:maingame.cpp†L551-L636】【F:maingame.cpp†L638-L720】`
    - 用户交互：`Cardpanel()` 处理点击选牌；`UserPlayHand()` 校验牌型/能否压制并发送出牌信号；`UserNoPlayer()` 处理“要不起”；`AutoPlayFirstCard()` 超时自动出第一张。`【F:maingame.cpp†L832-L874】【F:maingame.cpp†L937-L1030】【F:maingame.cpp†L1032-L1076】【F:maingame.cpp†L1078-L1103】`
    - 倒计时：`InitPlayerTimer()` 设置计时器，超时自动出牌或要不起，播放提醒音效。`【F:maingame.cpp†L1224-L1280】`
    - 结算与重开：`InitEndPanel()` 弹出结算窗体并在继续时清理牌面、重置控制器和按钮。`【F:maingame.cpp†L875-L936】`
  - 辅助：`ShowPlayerInfoImage()`、`CalculateLabelPosAbovePlayArea()` 等负责标签放置；`Showanimation()` 根据牌型播放动画与音效。`【F:maingame.cpp†L159-L176】【F:maingame.cpp†L283-326】`

### 1.3 玩家与 AI
- **player**：封装手牌、前后家关系、角色/性别、得分、获胜状态与牌面正反。暴露信号 `notifygrablordbet`、`notifyplayhand`、`notifystorecard`、`notifyTime`。`【F:player.h†L13-L105】`
  - 提供 `StoreGetCard(s)`、`RemoveCards`、`ClearCards`、`SetPendinfo`、`ResetForNewGame` 等操作。`【F:player.cpp†L45-L239】`
- **user**：继承 `player`，主要依赖界面按钮触发 `grablordbet` 与 `PlayHand`（实现集中在 UI 侧）。
- **robot**：重写 `PrepareGetLord()` 与 `PreparePlayCard()`，在后台线程中调用策略：
  - `RobotGetLard()` 根据王、顺子/炸弹、对子、2 的数量计算权重决定叫分。`【F:robot.cpp†L15-L66】`
  - `RobotThinkPlayhand()` 使用 `Strategy` 选择可行出牌组合并触发 `PlayHand`。`【F:robot.cpp†L67-L73】`
- **Strategy / robotgetloard / robotplayhand**：
  - `Strategy` 提供牌力评估与组合搜索（如 `GetrootPlayhand`、`Getsamecount`、`Getpair` 等）支撑 AI 出牌与叫分。`【F:strategy.h†L1-L49】`
  - `robotgetloard` 与 `robotplayhand` 线程类在 `Robot*` 中实例化并调用 `Strategy` 完成决策与信号回传。

### 1.4 牌型与数据结构
- **Card / Cards**：`Card` 保存花色与点数；`Cards` 基于 `QSet<Card*>` 管理集合，支持排序 `Listcardssort`、随机取牌 `takerandcard`、统计 `GetCardtotal`、删除 `removecards`。
- **PlayHand**：读取 `Cards` 判定牌型（单、对子、三带、顺子、连对、飞机、炸弹、王炸等），并提供 `CanBeat` 判断是否能压制上一手。`【F:playhand.h†L1-L57】`
- **_Playercontext**：`Maingame` 内部结构，缓存手牌区、出牌区、头像与提示标签指针、上一手牌 `_Last_Cards`，用于 UI 布局与出牌展示。`【F:maingame.cpp†L221-L309】【F:maingame.cpp†L603-L636】`

## 2. 流程与状态设计
- **游戏状态机**（`gamecontrol::GameState` + `USERSTATE`）：
  - `PENDCARD` 发牌：洗牌、轮流取牌，剩余三张作底牌。
  - `GETLORD` 抢地主：三轮叫分，最高分者成为地主并获得底牌；无人叫分则重发。
  - `GIVECARD` 出牌：地主先出，记录最后有效出牌者/牌组，支持“要不起”。玩家手牌为空时结算并进入 `USERWIN` 状态以展示结果。`【F:gamecontrol.cpp†L145-L287】`
- **计时与自动行动**：倒计时到期时，若为用户自由出牌或地主首次出牌，自动打出第一张；否则自动“要不起”。`【F:maingame.cpp†L1224-L1280】【F:maingame.cpp†L1078-L1103】`
- **出牌判定**：用户出牌时根据 `PlayHand` 判型，若需压牌则用 `CanBeat` 对比当前场面；非法则拒绝出牌。`【F:maingame.cpp†L937-L1030】`
- **倍数与计分**：初始倍数为最高叫分；炸弹牌型翻倍；结算根据地主/农民身份增减分并标记胜负。`【F:gamecontrol.cpp†L229-L274】`
- **重新开局**：结算窗口点击继续后，调用 `RetCardDate` 清空牌堆、玩家状态与界面牌面，重置音效与倒计时，再次进入发牌阶段。`【F:maingame.cpp†L875-L936】【F:gamecontrol.cpp†L110-L138】`

## 3. 接口与信号槽
- `player::notifygrablordbet(player*, int)`：叫分信号，由 `gamecontrol::Onbet` 处理。`【F:player.h†L97-L105】【F:gamecontrol.cpp†L307-L350】`
- `player::notifyplayhand(player*, Cards*)`：出牌或要不起信号，由 `gamecontrol::GamePlayhand` 处理。`【F:player.h†L97-L105】【F:gamecontrol.cpp†L176-L287】`
- `gamecontrol::S_gamePlayHand(player*, Cards*)`：通知 UI 渲染出牌或“要不起”。`【F:maingame.cpp†L638-L689】`
- `gamecontrol::S_PlayerStateChange(player*, USERSTATE)`：驱动 UI 切换按钮状态、倒计时与结算。`【F:maingame.cpp†L722-L790】`
- `gamecontrol::S_LordDetermined(player*)`：地主确定后更新头像与地主牌展示。`【F:gamecontrol.cpp†L153-L175】【F:maingame.cpp†L1455-L1481】`
- `gamecontrol::S_StopCountdown`：通知界面重置倒计时，避免跨阶段误触。`【F:gamecontrol.cpp†L110-L138】【F:maingame.cpp†L95-L105】`

## 4. 关键算法与策略
- **牌型识别**：`PlayHand` 根据牌点分组、连牌长度、对子/三条/炸弹判定组合，支持顺子、连对、飞机、炸弹、王炸等特殊规则。`【F:playhand.h†L1-L57】`
- **AI 叫分策略**：`robot::RobotGetLard` 依据王、顺子/炸弹、2 和对子数量打分，得分区间映射到 0~3 的叫分决策。`【F:robot.cpp†L15-L66】`
- **AI 出牌策略**：`Strategy` 评估牌力、生成首出或压牌方案（如 `GetrootPlayhand`、`Getpair`、`Getsamecount`），`RobotThinkPlayhand` 选择结果并出牌。`【F:strategy.h†L1-L49】【F:robot.cpp†L67-L73】`
- **倒计时与自动行动**：倒计时触发后根据是否自由出牌/地主首出，自动选第一张或发送空牌集合表示“要不起”。`【F:maingame.cpp†L1224-L1280】【F:maingame.cpp†L1032-L1076】`

## 5. 资源与音效
- 音效控制：`Bgmcontrol` 在发牌、出牌、炸弹、飞机、要不起、结果等事件播放对应音效；背景音乐在游戏开始时启动并在重新开局或结算时停止。`【F:maingame.cpp†L48-L55】【F:maingame.cpp†L670-L685】【F:maingame.cpp†L875-L908】`
- 动画：`AnmationPixmap` 展示叫分动画、连牌/炸弹/飞机特效；`Showanimation` 根据牌型调整大小和位置。`【F:maingame.cpp†L309-L326】【F:maingame.cpp†L1283-L1319】`
- 资源管理：`InitCardpanelMap` 裁剪 `:/images/card.png` 生成 54 张牌面与背面；`res.qrc` 统一嵌入图片、音频与配置文件以便跨平台分发。`【F:maingame.cpp†L177-L220】`

## 6. 数据与存储
- 项目不使用数据库或磁盘持久化。牌堆、手牌、分数等均存储在内存对象（`Cards`、`player`、`gamecontrol`）中；音效列表存放于 `conf/playList.json` 并通过 Qt 资源系统加载。

## 7. 错误处理与健壮性
- “要不起”时不更新 `_PlayHandplayer`，避免错误覆盖上一手有效出牌者；同时提前返回并切换下家。`【F:gamecontrol.cpp†L176-L205】`
- 重新开局前重置 `_Last_Cards`、倒计时、倍数与音效，防止空指针或状态泄漏导致崩溃。`【F:maingame.cpp†L309-L377】【F:maingame.cpp†L875-L936】`
- 出牌选择时校验是否轮到用户、是否处于出牌阶段，避免机器人回合误触。`【F:maingame.cpp†L832-L874】`

## 8. 未来扩展点
- 网络对战：可在 `gamecontrol` 增加网络同步接口，与远端玩家同步牌局状态。
- 数据持久化：可引入成绩记录与回放功能，将分数/牌局写入本地文件或数据库。
- AI 优化：在 `Strategy` 中加入蒙特卡洛或搜索算法，提高机器人决策质量。
