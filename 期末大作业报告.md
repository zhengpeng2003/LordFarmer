# 期末大作业报告

## 1. 选题背景

本项目选题为三人扑克牌游戏“斗地主”的桌面端实现。通过 Qt 框架构建图形界面，加入动画、音频与交互逻辑，并实现基础 AI 人机对战。
 斗地主具有规则清晰、流程完整、实现难度适中的特点，适合作为课程设计或期末大作业，既能体现编程能力，也可展示架构设计水平与系统集成能力。

------

## 2. 开发环境说明

- **语言**：C++17
- **框架**：Qt Widgets（界面）+ Qt Multimedia（音频）
- **工程结构**：`LandFarmer.pro` 管理项目，`res.qrc` 统一管理图片/音效/配置文件
- **运行环境**：支持 Windows / Linux / macOS 桌面系统
- **资源说明**：图片用于卡牌与背景展示，音频用于提示效果，JSON 提供牌型或配置数据

------

## 3. 系统功能说明

### （1）启动与加载界面

进入游戏时展示加载进度动画，动态加载资源，完成后进入主界面。

### （2）发牌与抢地主

- 洗牌基于随机算法
- 将手牌发放给三位玩家
- 进行三轮叫分，最高分者成为地主
- 地主获得三张底牌并进入出牌阶段

### （3）出牌与提示功能

- 支持鼠标点击或拖拽选择卡牌
- 玩家可选择出牌、提示、或“不要”
- 机器人自动根据策略模块作出决策
- 提供倒计时、音效提示、轮次指示等

### （4）倍数与计分机制

- 叫分决定初始倍数
- 炸弹与王炸触发翻倍
- 根据玩家身份（地主/农民）结算最终分数

### （5）结算与重新开始

显示本局胜负与积分变化，玩家可选择重新开始新的一局。

------

## 4. 系统设计说明

### （1）整体架构

系统采用三层结构：

- **UI 层（Maingame）**：界面显示、动画、用户交互
- **控制层（gamecontrol）**：管理状态机、游戏流程、规则校验
- **领域层（player / robot / strategy / playhand）**：玩家模型、AI 逻辑、牌型识别

这样可以实现高内聚、低耦合，增强项目可维护性与可扩展性。

### （2）数据流说明

- 控制层通过信号向 UI 发送状态更新（如“开始抢地主”“轮到出牌”）
- UI 根据信号更新界面（倒计时、发牌动画等）
- 用户或机器人操作通过 `notifygrablordbet`、`notifyplayhand` 等反馈给控制层
  形成完整的数据交互闭环。

### （3）状态机流程

系统运行主要由以下状态驱动：

1. `PENDCARD` —— 发牌
2. `GETLORD` —— 抢地主
3. `GIVECARD` —— 出牌
4. `USERWIN` —— 结算
5. 状态重置后回到 `PENDCARD`

状态机保证流程清晰、易于维护。

### （4）AI 设计

AI 基于以下逻辑实现：

- 使用 `Strategy` 评估牌力
- 生成所有可用牌型组合
- 综合当前局势选择相对合理的出牌
- 在简单规则下能完成基础对战逻辑，未来可扩展为搜索树算法

------

## 5. 技术点说明

- Qt 信号槽实现事件驱动
- 使用 `QPainter` 与 `QPixmap` 绘制卡牌、背景
- `QTimer` 控制动画节奏、倒计时
- `PlayHand` 完成牌型识别、合法性判断、比较逻辑
- `Strategy` 模块执行 AI 搜索与出牌决策
- Qt 资源系统统一管理图片与音效文件

------

## 6. 关键代码说明（文字解析）

### `Maingame::InitGamecontrol`

- 完成控制器初始化
- 绑定 UI 与控制层各类信号槽
- 确保 UI 能及时响应状态变化（进入抢地主界面、更新倒计时等）

### `gamecontrol::GamePlayhand`

- 游戏核心逻辑函数
- 判断出牌是否合法
- 处理“要不起”“跳过”等情况
- 自动倍数处理（炸弹等）
- 判断是否结束并进入结算
- 控制玩家轮转与流程推进

### `gamecontrol::Onbet`

- 管理三轮叫分过程
- 选择地主或触发重发牌
- 当有地主产生时进入正式对局阶段

### **PlayHand / Strategy**

- `PlayHand`：负责识别牌型（如顺子、三带二、飞机等）
- `Strategy`：负责 AI 决策逻辑

------

## 7. 系统界面说明

尽管仓库未提供截图，但界面布局可描述如下：

- 上方与左右为三个玩家的头像、身份、剩余牌数
- 中央区域用于展示当前出牌
- 下方为本地玩家手牌与功能按钮
- 显示倒计时、倍数等信息
- 背景图从 `images/background-*.png` 随机载入

------

## 8. 遇到的问题与解决方案

### （1）“要不起”未显示或无音效

**问题原因**：出牌为空时未触发 UI 更新信号。
 **解决方案**：在空牌分支增加 `S_gamePlayHand` 信号，使 UI 正常显示文字/音效反馈。

### （2）重新开局时的空指针风险

**问题原因**：`RePlayGame` 清理 `_Last_Cards` 时未判空导致潜在崩溃。
 **解决方案**：增加判空逻辑，确保资源释放安全。

### （3）上一局状态残留

**问题原因**：牌堆、出牌记录未完全重置。
 **解决方案**：在 `RetCardDate` 中统一清理和恢复初始状态，避免干扰下一局游戏。

------

## 9. 测试说明

### 手动测试

- 发牌流程测试
- 抢地主流程
- 出牌正确性
- 炸弹触发倍数变化
- 结算流程正确性

### 边界测试

- 三人均不叫分
- 多轮连续“不要”
- 炸弹、王炸等特殊牌型
- 频繁重开一局的稳定性

### 自动化测试

仓库暂未提供，可以后补充单元测试与 AI 行为自动测试。

------

## 10. 项目总结

本项目完成了斗地主的完整游戏流程，UI 显示、动画表现、音效反馈与 AI 决策协同工作，形成一个可正常运行的桌面端游戏。

- 架构清晰，控制层 `gamecontrol` 有效管理状态机、出牌规则、倍数变更与事件流
- UI 层直观地表现游戏流程，用户体验完整
- AI 策略虽为基础，但具备改进空间，可扩展为搜索型 AI 或深度学习 AI
- 本项目对图形渲染、事件驱动、算法逻辑、软件结构设计等方面均有较好实践意义

后续可扩展功能包括：

- 网络对战
- 战绩记录与持久化
- 更智能的 AI
- 加入自动化测试体系

------

## 11. 参考文献

- Qt 官方文档（Widgets、Multimedia、资源系统）
- 斗地主规则与常用牌型策略资料

------

## 12. 附录：大模型协作过程记录

- 梳理仓库结构，确认主要模块
- 分析 `maingame.cpp`、`gamecontrol.cpp`、`player`、`robot`、`strategy`、`playhand` 等核心逻辑
- 提取游戏流程、状态机、功能模块并编写设计说明
- 将问题分析、解决方案、测试点整合成完整报告
- 形成最终期末报告文档内容

------

